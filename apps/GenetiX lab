import React, { useState, useEffect, useMemo } from 'react';
import { initializeApp } from 'firebase/app';
import { getAuth, onAuthStateChanged, signInAnonymously, signInWithCustomToken } from 'firebase/auth';
import { getFirestore, doc, setDoc, onSnapshot, collection, updateDoc, query } from 'firebase/firestore';
import { 
  Dna, 
  RotateCcw, 
  PlusCircle, 
  MinusCircle, 
  RefreshCw, 
  Users, 
  MessageSquare, 
  Save,
  CheckCircle2, 
  AlertCircle,
  ArrowRight,
  Settings,
  Eye,
  Download,
  Table,
  BookOpen,
  Info,
  ChevronRight
} from 'lucide-react';

// --- Cấu hình Firebase ---
const firebaseConfig = JSON.parse(__firebase_config);
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
const appId = typeof __app_id !== 'undefined' ? __app_id : 'gene-mutation-lab-v5';

// --- Bảng mã di truyền ---
const CODON_TABLE = {
  'UUU': 'Phe', 'UUC': 'Phe', 'UUA': 'Leu', 'UUG': 'Leu',
  'UCU': 'Ser', 'UCC': 'Ser', 'UCA': 'Ser', 'UCG': 'Ser',
  'UAU': 'Tyr', 'UAC': 'Tyr', 'UAA': 'STOP', 'UAG': 'STOP',
  'UGU': 'Cys', 'UGC': 'Cys', 'UGA': 'STOP', 'UGG': 'Trp',
  'CUU': 'Leu', 'CUC': 'Leu', 'CUA': 'Leu', 'CUG': 'Leu',
  'CCU': 'Pro', 'CCC': 'Pro', 'CCA': 'Pro', 'CCG': 'Pro',
  'CAU': 'His', 'CAC': 'His', 'CAA': 'Gln', 'CAG': 'Gln',
  'CGU': 'Arg', 'CGC': 'Arg', 'CGA': 'Arg', 'CGG': 'Arg',
  'AUU': 'Ile', 'AUC': 'Ile', 'AUA': 'Ile', 'AUG': 'Met (Start)',
  'ACU': 'Thr', 'ACC': 'Thr', 'ACA': 'Thr', 'ACG': 'Thr',
  'AAU': 'Asn', 'AAC': 'Asn', 'AAA': 'Lys', 'AAG': 'Lys',
  'AGU': 'Ser', 'AGC': 'Ser', 'AGA': 'Arg', 'AGG': 'Arg',
  'GUU': 'Val', 'GUC': 'Val', 'GUA': 'Val', 'GUG': 'Val',
  'GCU': 'Ala', 'GCC': 'Ala', 'GCA': 'Ala', 'GCG': 'Ala',
  'GAU': 'Asp', 'GAC': 'Asp', 'GAA': 'Glu', 'GAG': 'Glu',
  'GGU': 'Gly', 'GGC': 'Gly', 'GGA': 'Gly', 'GGG': 'Gly',
};

const SCENARIOS = {
  group1: {
    name: 'Nhóm 1',
    disease: 'Bệnh hồng cầu hình liềm',
    gene: 'HBB (Beta-globin)',
    dna: 'GTGCACCTGACTCCTGAGGAGAAG',
    description:
      'Đột biến thay thế một nucleotide trong codon thứ 6 của gene HBB làm bộ ba mã hóa GAG (mã hóa Glutamic acid) biến thành GTG (mã hóa Valine). Sự thay đổi từ amino acid ưa nước sang kỵ nước khiến hemoglobin kết tủa khi thiếu oxy, làm hồng cầu biến dạng hình liềm.',
    hint:
      'Hãy thay đổi nucleotide A thành T tại vị trí 17.',
    defaultType: 'substitution'
  },

  group2: {
    name: 'Nhóm 2',
    disease: 'Bệnh xơ nang',
    gene: 'CFTR',
    dna: 'ATCATCTTTGGTGTTTCCTAT',
    description:
      'Đột biến mất đoạn 3 nucleotide tương ứng với bộ ba mã hóa Phenylalanine (ΔF508) làm protein CFTR bị gấp cuộn sai, không được vận chuyển ra màng tế bào, dẫn đến rối loạn vận chuyển ion Cl⁻.',
    hint:
      'Hãy xóa 3 nucleotide liên tiếp tại vị trí 4–6.',
    defaultType: 'deletion'
  },

  group3: {
    name: 'Nhóm 3',
    disease: 'Bệnh Huntington',
    gene: 'HTT (Huntingtin)',
    dna: 'ATGGCGACCCTGGAAAAGCTG',
    description:
      'Sự mở rộng số lần lặp lại của bộ ba mã hóa CAG trong vùng mã hóa gene HTT làm protein Huntingtin chứa quá nhiều Glutamine (poly-Q), gây gấp cuộn sai và thoái hóa tế bào thần kinh.',
    hint:
      'Hãy thêm một hoặc nhiều bộ ba "CAG" tại vị trí nucleotide số 7.',
    defaultType: 'insertion'
  },

  group4: {
    name: 'Nhóm 4',
    disease: 'Bệnh Phenylketonuria',
    gene: 'PAH',
    dna: 'TCCCGGTGGCTCCTGCTCCTG',
    description:
      'Đột biến thay thế nucleotide trong gene PAH làm thay đổi cấu trúc enzyme phenylalanine hydroxylase, khiến enzyme mất hoặc giảm hoạt tính, dẫn đến tích tụ phenylalanine gây tổn thương não.',
    hint:
      'Hãy thay đổi nucleotide C thành T tại vị trí nucleotide số 2.',
    defaultType: 'substitution'
  },

  group5: {
    name: 'Nhóm 5',
    disease: 'Bệnh Tay-Sachs',
    gene: 'HEXA',
    dna: 'CGTATATCCTATGCCCCTGAC',
    description:
      'Đột biến thêm đoạn 4 nucleotide trong gene HEXA làm dịch khung đọc, dẫn đến protein enzyme hexosaminidase A bị cắt ngắn và mất chức năng phân giải lipid trong tế bào thần kinh.',
    hint:
      'Hãy thêm chuỗi "TATC" tại vị trí nucleotide số 5.',
    defaultType: 'insertion'
  },

  group6: {
    name: 'Nhóm 6',
    disease: 'Bệnh mù màu đỏ-xanh',
    gene: 'OPN1LW/OPN1MW',
    dna: 'ATGGCCTCTCCGCAGCCGCTG',
    description:
      'Đột biến mất đoạn trong gene mã hóa opsin của tế bào nón làm protein opsin bị thiếu amino acid quan trọng, khiến tế bào võng mạc không hấp thụ được ánh sáng ở một số bước sóng (đỏ hoặc xanh).',
    hint:
      'Hãy xóa 3 hoặc 6 nucleotide liên tiếp từ vị trí số 4',
    defaultType: 'deletion'
  },

  group7: {
    name: 'Nhóm 7',
    disease: 'Hội chứng Lão nhi',
    gene: 'LMNA',
    dna: 'ATGGCTCAGCTCAGGGAATTT',
    description:
      'Đột biến thay thế nucleotide trong gene LMNA tạo ra vị trí cắt nối intron giả, dẫn đến mRNA bị cắt sai và hình thành protein progerin bất thường, gây lão hóa sớm nghiêm trọng.',
    hint:
      'Hãy thay đổi nucleotide C thành T tại vị trí số 12.',
    defaultType: 'substitution'
  },

  group8: {
    name: 'Nhóm 8',
    disease: 'Bệnh Thalassemia',
    gene: 'HBA (Alpha-globin)',
    dna: 'ATGGTGCTGTCTCCTGCCGAC',
    description:
      'Đột biến mất một nucleotide trong gene HBA làm dịch khung đọc, dẫn đến chuỗi alpha-globin bị biến đổi hoàn toàn và xuất hiện codon kết thúc sớm, gây giảm hoặc mất khả năng tổng hợp hemoglobin.',
    hint:
      'Hãy xóa nucleotide tại vị trí số 5.',
    defaultType: 'deletion'
  }
};

const BASE_COLORS = {
  'A': 'bg-emerald-100 text-emerald-800 border-emerald-300',
  'T': 'bg-rose-100 text-rose-800 border-rose-300',
  'G': 'bg-sky-100 text-sky-800 border-sky-300',
  'C': 'bg-amber-100 text-amber-800 border-amber-300',
  'U': 'bg-purple-100 text-purple-800 border-purple-300'
};

const dnaToMrna = (dna) => dna.toUpperCase().replace(/T/g, 'U');
const translate = (mrna) => {
  const codons = [];
  for (let i = 0; i <= mrna.length - 3; i += 3) {
    codons.push(mrna.substring(i, i + 3));
  }
  return codons.map(c => CODON_TABLE[c] || '???');
};

export default function App() {
  const [user, setUser] = useState(null);
  const [teamKey, setTeamKey] = useState('group1');
  const [isJoined, setIsJoined] = useState(false);
  const [showCodonTable, setShowCodonTable] = useState(false);
  
  const currentScenario = SCENARIOS[teamKey];
  const teamId = teamKey;

  const [teamData, setTeamData] = useState({
    dnaOriginal: currentScenario.dna,
    dnaMutated: currentScenario.dna,
    mutationType: currentScenario.defaultType,
    pos: 1,
    val: '',
    lastMutation: { type: null, pos: null, len: 0 },
    notes: { q1: '', q2: '', q3: '' }
  });

  useEffect(() => {
    const initAuth = async () => {
      if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
        await signInWithCustomToken(auth, __initial_auth_token);
      } else {
        await signInAnonymously(auth);
      }
    };
    initAuth();
    const unsubscribe = onAuthStateChanged(auth, setUser);
    return () => unsubscribe();
  }, []);

  useEffect(() => {
    if (!user || !isJoined) return;
    const docRef = doc(db, 'artifacts', appId, 'public', 'data', 'teams', teamId);
    const unsubscribe = onSnapshot(docRef, (docSnap) => {
      if (docSnap.exists()) {
        const data = docSnap.data();
        setTeamData(prev => ({
          ...prev,
          ...data,
          notes: data.notes || prev.notes,
          lastMutation: data.lastMutation || prev.lastMutation
        }));
      } else {
        setDoc(docRef, teamData);
      }
    });
    return () => unsubscribe();
  }, [user, isJoined, teamId]);

  const updateCloud = async (newData) => {
    if (!user || !isJoined) return;
    const docRef = doc(db, 'artifacts', appId, 'public', 'data', 'teams', teamId);
    try {
      await updateDoc(docRef, newData);
    } catch (err) { console.error(err); }
  };

  const handleGroupChange = (key) => {
    setTeamKey(key);
    const scenario = SCENARIOS[key];
    const newData = {
      dnaOriginal: scenario.dna,
      dnaMutated: scenario.dna,
      mutationType: scenario.defaultType,
      pos: 1,
      val: '',
      lastMutation: { type: null, pos: null, len: 0 }
    };
    setTeamData(prev => ({ ...prev, ...newData }));
  };

  const applyMutation = () => {
    const { dnaOriginal, mutationType, pos, val } = teamData;
    let mutated = dnaOriginal;
    const p = Math.max(0, parseInt(pos) - 1);
    let mutLen = 0;

    if (mutationType === 'deletion') {
      const len = parseInt(val) || 1;
      mutated = dnaOriginal.slice(0, p) + dnaOriginal.slice(p + len);
      mutLen = 0;
    } else if (mutationType === 'insertion') {
      const insertedSeq = val.toUpperCase().replace(/[^ATGC]/g, '');
      mutated = dnaOriginal.slice(0, p) + insertedSeq + dnaOriginal.slice(p);
      mutLen = insertedSeq.length;
    } else if (mutationType === 'substitution') {
      const subChar = val.toUpperCase().replace(/[^ATGC]/g, '').slice(0, 1);
      mutated = dnaOriginal.slice(0, p) + subChar + dnaOriginal.slice(p + 1);
      mutLen = subChar ? 1 : 0;
    }

    const update = { 
      dnaMutated: mutated,
      mutationType: mutationType,
      pos: pos,
      val: val,
      lastMutation: { type: mutationType, pos: p, len: mutLen }
    };
    
    setTeamData(prev => ({ ...prev, ...update }));
    updateCloud(update);
  };

  // Hàm xử lý thoát ra màn hình chính và reset dữ liệu nhập liệu
  const handleExit = () => {
    setIsJoined(false);
    // Reset các thông tin nhập liệu nhưng giữ nguyên kết quả DNA và ghi chú
    const resetInputs = {
      pos: 1,
      val: '',
      mutationType: currentScenario.defaultType
    };
    setTeamData(prev => ({ ...prev, ...resetInputs }));
    updateCloud(resetInputs);
  };

  const mrnaOrig = dnaToMrna(teamData.dnaOriginal);
  const mrnaMut = dnaToMrna(teamData.dnaMutated);
  const protOrig = translate(mrnaOrig);
  const protMut = translate(mrnaMut);

  if (!isJoined) {
    return (
      <div className="min-h-screen bg-slate-50 flex items-center justify-center p-6 text-slate-900 font-sans">
        <div className="max-w-2xl w-full bg-white rounded-3xl shadow-2xl p-10 border border-slate-200">
          <div className="flex justify-center mb-6">
            <div className="p-4 bg-indigo-600 rounded-2xl text-white shadow-lg"><Dna size={40} /></div>
          </div>
          <h1 className="text-3xl font-black text-center mb-2">GenetiX Lab</h1>
          <p className="text-slate-500 text-center mb-8">Hãy chọn nhóm của bạn để bắt đầu mô phỏng</p>
          <div className="grid grid-cols-2 md:grid-cols-4 gap-3 mb-10">
            {Object.keys(SCENARIOS).map((key) => (
              <button key={key} onClick={() => handleGroupChange(key)} className={`p-4 rounded-2xl border-2 transition-all flex flex-col items-center gap-2 ${teamKey === key ? 'border-indigo-600 bg-indigo-50 shadow-md scale-105' : 'border-slate-100 hover:border-slate-300'}`}>
                <Users size={20} className={teamKey === key ? 'text-indigo-600' : 'text-slate-400'} />
                <span className="text-xs font-bold uppercase">{SCENARIOS[key].name}</span>
              </button>
            ))}
          </div>
          <div className="space-y-4">
            <button onClick={() => setIsJoined(true)} className="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-5 rounded-2xl shadow-xl shadow-indigo-100 transition-all flex items-center justify-center gap-3 text-xl active:scale-95">
              Vào thực hành {currentScenario.name} <ArrowRight size={22} />
            </button>
          </div>
        </div>
      </div>
    );
  }

  return (
    <div className="min-h-screen bg-slate-50 p-4 md:p-8 text-slate-900 font-sans">
      <header className="max-w-7xl mx-auto flex flex-col md:flex-row items-center justify-between mb-8 gap-4">
        <div className="flex items-center gap-3">
          <div className="p-2 bg-indigo-600 rounded-xl text-white shadow-md"><Dna size={24} /></div>
          <h1 className="text-2xl font-black text-slate-800 tracking-tight">GenetiX <span className="text-indigo-600">Lab</span></h1>
        </div>
        <div className="flex items-center gap-3">
          <div className="flex bg-white rounded-2xl border p-1 shadow-sm items-center">
             <Users size={14} className="ml-3 text-indigo-500"/>
             <span className="px-3 py-1.5 text-xs font-black uppercase text-indigo-700">{currentScenario.name}</span>
          </div>
          {/* Sử dụng handleExit thay vì setIsJoined(false) trực tiếp */}
          <button onClick={handleExit} className="p-2 text-slate-400 hover:text-red-500 transition-colors bg-white rounded-xl border shadow-sm" title="Đổi nhóm"><RotateCcw size={18}/></button>
        </div>
      </header>

      <main className="max-w-7xl mx-auto space-y-8">
        <section className="bg-gradient-to-br from-indigo-700 via-indigo-800 to-slate-900 text-white p-6 sm:p-8 rounded-[2rem] shadow-2xl relative overflow-hidden border border-indigo-500/20">
          <div className="relative z-10">
            <div className="flex items-center gap-3 mb-4">
              <div className="p-2 bg-white/10 rounded-lg backdrop-blur-md border border-white/20"><BookOpen size={20} className="text-indigo-300"/></div>
              <span className="text-[10px] font-black uppercase tracking-[0.2em] text-indigo-200">Bệnh di truyền - {currentScenario.name}</span>
            </div>
            <h3 className="text-2xl font-black mb-3 text-transparent bg-clip-text bg-gradient-to-r from-white to-indigo-200">{currentScenario.disease}</h3>
            <p className="text-indigo-100/80 text-sm leading-relaxed mb-6 font-medium">Gene: <span className="text-indigo-300 font-bold">{currentScenario.gene}</span>. {currentScenario.description}</p>
            <div className="flex flex-wrap items-center gap-3">
              <div className="flex items-center gap-2 px-4 py-2 bg-white/5 rounded-xl text-xs font-bold border border-white/10 backdrop-blur-sm">
                <Info size={14} className="text-amber-400"/> Gợi ý: {currentScenario.hint}
              </div>
            </div>
          </div>
          <Dna className="absolute -right-16 -bottom-16 text-white/5 w-64 h-64 rotate-12" />
        </section>

        <section className="bg-white p-6 sm:p-8 rounded-[2rem] shadow-sm border border-slate-200 relative">
          <div className="flex items-center justify-between mb-6">
            <h2 className="text-lg font-black flex items-center gap-3 text-slate-800"><Settings size={18} className="text-indigo-600"/> 1. Trình tự Gene gốc</h2>
            <span className="px-3 py-1 bg-slate-100 text-slate-500 rounded-lg text-[10px] font-black uppercase tracking-widest">{teamData.dnaOriginal.length} Nu</span>
          </div>
          <div className="p-4 sm:p-6 bg-slate-50 border border-slate-100 rounded-[1.5rem] overflow-x-auto custom-scrollbar shadow-inner">
            <div className="flex gap-2 min-w-max pb-2">
              {teamData.dnaOriginal.split('').map((b, i) => (
                <div key={i} className="flex flex-col items-center">
                  <span className="text-[9px] text-slate-300 font-black mb-1">{i+1}</span>
                  <div className={`w-9 h-12 flex items-center justify-center border-2 rounded-xl text-sm font-black shadow-sm transition-all ${BASE_COLORS[b]}`}>{b}</div>
                  <span className="text-[8px] text-slate-400 font-bold mt-2">{(i % 3 === 0) ? `C${(i/3)+1}` : ''}</span>
                </div>
              ))}
            </div>
          </div>
        </section>

        <section className="bg-white p-6 sm:p-8 rounded-[2rem] shadow-sm border border-slate-200">
          <h2 className="text-lg font-black mb-6 flex items-center gap-3 text-slate-800"><AlertCircle size={18} className="text-rose-500"/> 2. Mô phỏng Đột biến</h2>
          <div className="grid grid-cols-1 sm:grid-cols-2 xl:grid-cols-4 gap-4 mb-8">
            <div className="space-y-2">
              <label className="text-[10px] font-black text-slate-400 uppercase tracking-widest px-1 block">Hình thức đột biến</label>
              <select value={teamData.mutationType} onChange={(e) => setTeamData({...teamData, mutationType: e.target.value})} className="w-full h-12 p-3 bg-slate-50 border border-slate-200 rounded-2xl outline-none font-bold text-xs focus:ring-4 focus:ring-indigo-50 transition-all appearance-none cursor-pointer">
                <option value="substitution">Thay thế</option>
                <option value="deletion">Mất đoạn</option>
                <option value="insertion">Thêm đoạn</option>
              </select>
            </div>
            <div className="space-y-2">
              <label className="text-[10px] font-black text-slate-400 uppercase tracking-widest px-1 block">Vị trí</label>
              <input type="number" value={teamData.pos} min="1" max={teamData.dnaOriginal.length} onChange={(e) => setTeamData({...teamData, pos: e.target.value})} className="w-full h-12 p-3 bg-slate-50 border border-slate-200 rounded-2xl outline-none font-bold text-sm focus:ring-4 focus:ring-indigo-50 transition-all" />
            </div>
            <div className="space-y-2">
              <label className="text-[10px] font-black text-slate-400 uppercase tracking-widest px-1 block truncate">
                {teamData.mutationType === 'deletion' ? 'Số lượng nucleotide bị mất' : 
                 teamData.mutationType === 'substitution' ? 'Nucleotide thay thế' : 'Trình tự nucleotide thêm mới'}
              </label>
              <input type="text" value={teamData.val} onChange={(e) => setTeamData({...teamData, val: e.target.value})} className="w-full h-12 p-3 bg-slate-50 border border-slate-200 rounded-2xl outline-none font-mono font-bold text-indigo-600 focus:ring-4 focus:ring-indigo-50 transition-all text-sm" placeholder={teamData.mutationType === 'deletion' ? "VD: 3" : "VD: AAA"} />
            </div>
            <div className="flex items-end">
              <button onClick={applyMutation} className="w-full h-12 bg-indigo-600 hover:bg-indigo-700 text-white font-black rounded-2xl transition-all shadow-lg shadow-indigo-100 flex items-center justify-center gap-2 text-xs uppercase tracking-wider active:scale-95">Mô phỏng <ChevronRight size={14}/></button>
            </div>
          </div>
          <div className="p-4 sm:p-6 bg-rose-50/50 border border-rose-100 rounded-[1.5rem] overflow-x-auto custom-scrollbar">
            <div className="flex items-center gap-3 mb-4">
              <div className="w-2 h-2 rounded-full bg-rose-500 animate-ping"></div>
              <span className="text-[10px] font-black text-rose-500 uppercase tracking-widest">DNA Đột biến</span>
            </div>
            <div className="flex gap-2 min-w-max pb-3">
              {teamData.dnaMutated.split('').map((b, i) => {
                const { type, pos, len } = teamData.lastMutation || { type: null, pos: null, len: 0 };
                const isMutationHighlight = (type && pos !== null && teamData.dnaMutated !== teamData.dnaOriginal) && (
                  (type === 'substitution' && i === pos) ||
                  (type === 'insertion' && i >= pos && i < pos + len)
                );
                return (
                  <div key={i} className="flex flex-col items-center">
                    <span className="text-[9px] text-slate-300 font-black mb-1">{i+1}</span>
                    <div className={`w-9 h-12 flex items-center justify-center border-2 rounded-xl text-sm font-black shadow-sm transition-all ${BASE_COLORS[b] || 'bg-slate-100'} ${isMutationHighlight ? 'ring-2 ring-rose-500 ring-offset-2 border-rose-400 bg-rose-50' : 'border-slate-200'}`}>{b}</div>
                    <span className="text-[8px] text-slate-400 font-bold mt-2">{(i % 3 === 0) ? `C${(i/3)+1}` : ''}</span>
                  </div>
                );
              })}
            </div>
          </div>
        </section>

        <section className="bg-slate-900 text-white p-6 sm:p-10 rounded-[2.5rem] shadow-2xl overflow-x-auto custom-scrollbar border border-white/5">
          <div className="flex items-center justify-between mb-10">
            <div>
              <h2 className="text-xl font-black flex items-center gap-3"><RefreshCw size={24} className="text-indigo-400 animate-spin-slow"/> 3. Phân tích Dịch mã</h2>
              <p className="text-slate-500 text-xs mt-2 font-medium">DNA → mRNA → Amino Acid</p>
            </div>
            <button onClick={() => setShowCodonTable(!showCodonTable)} className={`px-4 py-2 sm:px-6 sm:py-2.5 rounded-2xl text-[10px] font-black uppercase tracking-widest transition-all flex items-center gap-2 shadow-lg ${showCodonTable ? 'bg-indigo-600 text-white shadow-indigo-500/20' : 'bg-slate-800 text-indigo-400 hover:bg-slate-700'}`}>
              <Table size={16}/> {showCodonTable ? 'Ẩn bảng mã di truyền' : 'Hiện bảng mã di truyền'}
            </button>
          </div>
          {showCodonTable && (
            <div className="grid grid-cols-4 md:grid-cols-8 gap-2 mb-10 animate-in fade-in slide-in-from-top-4 text-[9px] font-mono p-6 bg-white/5 rounded-3xl border border-white/10 backdrop-blur-xl">
              {Object.entries(CODON_TABLE).map(([c, a]) => (
                <div key={c} className="p-2 border border-white/5 rounded-xl bg-slate-800/50 flex flex-col items-center hover:bg-indigo-600/20 transition-colors">
                  <div className="text-indigo-300 font-black">{c}</div><div className="opacity-50 font-bold">{a}</div>
                </div>
              ))}
            </div>
          )}
          <div className="space-y-12 min-w-max pb-2">
            <div className="space-y-6">
              <div className="p-6 bg-white/5 rounded-[2rem] border border-white/10 shadow-inner">
                <div className="flex items-center justify-between mb-6">
                  <p className="text-[10px] text-slate-400 uppercase font-black tracking-widest flex items-center gap-2"><span className="w-2 h-2 rounded-full bg-emerald-500"></span> Protein gốc</p>
                  <span className="text-[10px] font-bold text-slate-500">{protOrig.length} AA</span>
                </div>
                <div className="flex flex-wrap gap-2">
                  {protOrig.map((aa, i) => (
                    <div key={i} className="flex flex-col items-center group">
                      <div className="px-4 py-3 sm:px-5 sm:py-3 bg-slate-800 rounded-2xl text-xs font-black border border-white/5 text-emerald-400 shadow-xl">{aa}</div>
                      <span className="text-[8px] text-slate-600 mt-2 font-black">{mrnaOrig.substring(i*3, i*3+3)}</span>
                    </div>
                  ))}
                </div>
              </div>
              <div className="p-6 bg-rose-500/5 rounded-[2rem] border border-rose-500/10 shadow-inner">
                <div className="flex items-center justify-between mb-6">
                  <p className="text-[10px] text-rose-400 uppercase font-black tracking-widest flex items-center gap-2"><span className="w-2 h-2 rounded-full bg-rose-500 shadow-[0_0_10px_rgba(244,63,94,0.5)]"></span> Protein đột biến</p>
                  <span className="text-[10px] font-bold text-rose-500/60">{protMut.length} AA</span>
                </div>
                <div className="flex flex-wrap gap-2">
                  {protMut.map((aa, i) => (
                    <div key={i} className="flex flex-col items-center">
                      <div className={`px-4 py-3 sm:px-5 sm:py-3 rounded-2xl text-xs font-black border transition-all shadow-xl ${aa !== protOrig[i] ? 'bg-rose-600 border-rose-400 text-white animate-pulse' : 'bg-slate-800 border-white/5 text-slate-500 opacity-60'}`}>{aa}</div>
                      <span className="text-[8px] text-slate-600 mt-2 font-black">{mrnaMut.substring(i*3, i*3+3)}</span>
                    </div>
                  ))}
                </div>
                {protMut.length !== protOrig.length && (
                  <div className="mt-8 flex items-center gap-3 p-4 bg-rose-500/10 rounded-2xl border border-rose-500/20">
                    <AlertCircle size={20} className="text-rose-500"/>
                    <span className="text-xs font-black text-rose-400 uppercase tracking-tight">Cảnh báo: Lệch khung đọc</span>
                  </div>
                )}
              </div>
            </div>
          </div>
        </section>

        <section className="bg-white p-6 sm:p-10 rounded-[2.5rem] shadow-sm border border-slate-200">
          <div className="flex items-center justify-between mb-8">
            <h2 className="text-2xl font-black flex items-center gap-3 text-slate-800"><MessageSquare className="text-indigo-600" /> Thảo luận Khoa học & Báo cáo</h2>
          </div>
          <div className="grid grid-cols-1 md:grid-cols-3 gap-8 mb-10">
            {[
              { id: 'q1', label: '1. Đột biến trên ảnh hưởng đến cấu trúc của Protein như thế nào?', hint: 'Đột biến làm thay đổi trình tự nucleotide trên gene, từ đó có thể thay đổi amino acid và cấu trúc – chức năng của protein.' },
              { id: 'q2', label: '2. Đột biến trên ảnh hưởng đến cấu trúc của Protein như thế nào?', hint: 'Khi cấu trúc protein bị thay đổi do đột biến, chức năng của protein có thể bị thay đổi hoặc mất đi.' },
              { id: 'q3', label: '3. Đột biến trên có lợi hay hại? Em hãy giải thích?', hint: 'Đột biến có thể có lợi, có hại hoặc trung tính tùy mức độ ảnh hưởng đến protein' }
            ].map(q => (
              <div key={q.id} className="space-y-3">
                <label className="text-[10px] font-black text-slate-700 block uppercase tracking-widest px-1">{q.label}</label>
                <textarea value={teamData.notes[q.id]} onChange={(e) => { const newNotes = {...teamData.notes, [q.id]: e.target.value}; setTeamData({...teamData, notes: newNotes}); updateCloud({notes: newNotes}); }} placeholder={q.hint} className="w-full p-5 bg-slate-50 border border-slate-200 rounded-[1.5rem] text-sm focus:ring-4 focus:ring-indigo-50 outline-none transition-all placeholder:italic placeholder:text-slate-300 min-h-[140px] leading-relaxed shadow-inner" />
              </div>
            ))}
          </div>
          <div className="flex justify-center pt-8 border-t border-slate-100">
            <button onClick={() => {
              const content = `BÁO CÁO THỰC HÀNH DI TRUYỀN HỌC\n${currentScenario.name.toUpperCase()} - ID: ${teamId}\nTÌNH HUỐNG: ${currentScenario.disease}\nGENE LIÊN QUAN: ${currentScenario.gene}\nMÔ TẢ ĐỘT BIẾN: ${currentScenario.description}\n----------------------------------\nDNA GỐC: ${teamData.dnaOriginal}\nDNA ĐỘT BIẾN: ${teamData.dnaMutated}\n----------------------------------\nPROTEIN GỐC: ${protOrig.join(' - ')}\nPROTEIN ĐỘT BIẾN: ${protMut.join(' - ')}\n----------------------------------\n1. ẢNH HƯỞNG PROTEIN: ${teamData.notes.q1}\n\n2. HẬU QUẢ DI TRUYỀN: ${teamData.notes.q2}\n\n3. ĐÁNH GIÁ LỢI/HẠI: ${teamData.notes.q3}`;
              const blob = new Blob([content], {type: 'text/plain'});
              const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = `Bao_cao_${teamId}.txt`; a.click();
            }} className="max-w-md w-full bg-slate-900 text-white py-5 rounded-[2rem] font-black flex items-center justify-center gap-4 hover:bg-slate-800 transition-all shadow-2xl active:scale-95 text-lg">
              <Download size={24} /> XUẤT BÁO CÁO KẾT QUẢ
            </button>
          </div>
        </section>
      </main>

      <footer className="max-w-7xl mx-auto mt-16 text-center text-slate-400 text-[10px] font-black uppercase tracking-[0.3em] pb-12">GenetiX Lab &copy; 2026 - Phuong-Thao Ho</footer>
      <style dangerouslySetInnerHTML={{ __html: `
        @keyframes spin-slow { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        .animate-spin-slow { animation: spin-slow 15s linear infinite; }
        .custom-scrollbar::-webkit-scrollbar { height: 8px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: rgba(0, 0, 0, 0.05); border-radius: 10px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: rgba(99, 102, 241, 0.3); border-radius: 10px; border: 2px solid transparent; background-clip: content-box; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: rgba(99, 102, 241, 0.6); background-clip: content-box; }
        .custom-scrollbar { scrollbar-width: thin; scrollbar-color: rgba(99, 102, 241, 0.3) rgba(0, 0, 0, 0.05); }
      `}} />
    </div>
  );
}
